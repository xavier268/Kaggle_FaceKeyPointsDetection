---
title: "Prepare a submission file using correlation on sub windows"
output: 
  html_document: 
    toc: yes
---
# NE MARCHE PAS !!

# Testing a very basic scheame with correlations

## Loading the data

We load from the compiled, preformatted data saved earlier :

```{r Loading environement}
load("d.train.RData")
load("im.train.RData")
load("im.test.RData")
load("functions.viewing.RData")
set.seed(24)
ls()
```

## Basic idea

We will use a scheme where we try to correlate the eye centers, the mouse center, and the nose with the training data.

## Construct the windows for the nose center

```{r}
s <- 20# window 41x41

# storage for the centered nose windows
im.nose <- matrix(
  NA,
  nrow(d.train),
  (2*s+1)^2
  )

for(i in 1:nrow(d.train)) {
  x <- round(d.train[i,"nose_tip_x"])
  y <- round(d.train[i,"nose_tip_y"])
  if(x-s >= 1 & x+s <= 96 & y-s >= 1 & y+s<= 96 ){
    sw <- matrix(im.train[i,],96,96)[(x-s):(x+s),(y-s):(y+s)]

    }
}
# keeping only valid nose pictures
#im.nose <- im.nose[!is.na(im.nose[,1]),]
```

Ok, we now have a list of nose-centered subwindows.

How to make a classifier that can recognize one of these ? Versus a "non centered" picture ..






## Saving utility function

predictions is the structure containing the rows of predictions.

```{r reformating predictions}
predictions.save <- function(predictions) {
  submission <- read.csv(file = "../Dataset/IdLookupTable.csv")
  d.lookup <- as.character(names(d.train))
  
  for(i in 1:nrow(submission)){
    imId <- submission$ImageId[i]
    feat <- as.character(submission$FeatureName[i]) 
    # required as.character() ! 
    # Internal factor representations will not match corectly !!
    submission$Location[i] <- predictions[imId,which(d.lookup==feat)]
  }
  
  submission$ImageId <-  NULL
  submission$FeatureName <- NULL
  sfile <-format(Sys.time(), "SubmissionKnn%d%b%Yat%Hh%Mm%Ss.csv")
  write.csv(submission,file=sfile, row.names = FALSE, quote = FALSE)
  message("The file ",sfile," was saved for submission")
}
```

## Saving

```{r}
predictions.save(knn.predict)
```